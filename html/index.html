<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Drone Visualizer</title>
    
    <!-- Ê†∑ÂºèÊñá‰ª∂ -->
    <link rel="stylesheet" href="styles/main-base.css">
    <link rel="stylesheet" href="styles/mag-calibration.css">
    <link rel="stylesheet" href="styles/debug-panel.css">
    <link rel="stylesheet" href="styles/ui-theme.css">
    <link rel="stylesheet" href="styles/telemetry-panel.css">
    <link rel="stylesheet" href="styles/rc-monitor.css">
    <link rel="stylesheet" href="styles/motor-and-safety.css">
    <link rel="stylesheet" href="styles/imu-card.css">
    <link rel="stylesheet" href="styles/alerts.css">
    <link rel="stylesheet" href="styles/layout-foundation.css">
    <link rel="stylesheet" href="styles/layout-main-panels.css">
    <link rel="stylesheet" href="styles/layout-console.css">
    <link rel="stylesheet" href="styles/layout-hud.css">
    <link rel="stylesheet" href="styles/att-widget.css">
    <link rel="stylesheet" href="styles/navbar.css">
    <link rel="stylesheet" href="styles/axis-invert.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Three.js Ê†∏ÂøÉÂ∫ì -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>

    <div class="app-shell">
        <!-- È°∂ÈÉ®ÂØºËà™ -->
        <nav class="nav-shell">
            <div class="nav-left">
                <div class="nav-brand">
                    <div class="nav-brand-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="2" fill="white" stroke="none"></circle>
                            <path d="M10 10 L6 6" stroke-opacity="0.7"></path>
                            <path d="M14 10 L18 6" stroke-opacity="0.7"></path>
                            <path d="M10 14 L6 18" stroke-opacity="0.7"></path>
                            <path d="M14 14 L18 18" stroke-opacity="0.7"></path>
                            <path d="M3 6 C3 4 7 4 7 6" stroke-width="1.8"></path>
                            <path d="M17 6 C17 4 21 4 21 6" stroke-width="1.8"></path>
                            <path d="M3 18 C3 20 7 20 7 18" stroke-width="1.8"></path>
                            <path d="M17 18 C17 20 21 20 21 18" stroke-width="1.8"></path>
                        </svg>
                    </div>
                    <span>AERO</span>
                </div>
                <div class="nav-divider"></div>
                <div class="nav-status-strip">
                    <div class="nav-stat" id="nav-temp">
                        <i class="fa-solid fa-temperature-half icon"></i>
                        <span class="fixed-w" id="nav-temp-val">--</span><span class="unit">¬∞C</span>
                    </div>
                    <div class="nav-stat" id="nav-press">
                        <i class="fa-solid fa-gauge-high icon press-anim" id="nav-press-icon"></i>
                        <span class="fixed-w" id="nav-press-val">--</span><span class="unit">hPa</span>
                    </div>
                    <div class="nav-stat" id="nav-tof">
                        <i class="fa-solid fa-ruler-vertical icon"></i>
                        <span class="fixed-w" id="nav-tof-val">--</span><span class="unit">mm</span>
                    </div>
                    <div class="nav-stat" id="nav-bat">
                        <i class="fa-solid fa-battery-full icon" id="nav-bat-icon"></i>
                        <span class="fixed-w" id="nav-bat-val">--</span><span class="unit">V</span>
                    </div>
                </div>
            </div>
            <div class="nav-right">
                <button id="connectBtn" class="nav-btn-connect disconnected">
                    <i data-lucide="link"></i>
                    <span>ËøûÊé•‰∏≤Âè£</span>
                </button>
                <button id="recordBtn" class="btn btn-danger hidden"><i data-lucide="circle-dot"></i> ÂºÄÂßãÂΩïÂà∂</button>
                <div class="nav-tool">
                    <button id="magCalibBtn" class="nav-icon-btn" onclick="openMagCalibModal()"><i data-lucide="compass" class="nav-icon-rotate"></i></button>
                    <div class="nav-tooltip">Á£ÅÂäõËÆ°Ê†°ÂáÜ</div>
                </div>
                <div class="nav-tool">
                    <button id="motorTestBtn" class="nav-icon-btn"><i data-lucide="fan" class="nav-icon-fan"></i></button>
                    <div class="nav-tooltip">ÁîµÊú∫ÊµãËØï</div>
                </div>
                <div class="nav-tool">
                    <button id="resetAttitudeBtn" class="nav-icon-btn" onclick="resetAttitude()"><i data-lucide="rotate-ccw" class="nav-icon-reset"></i></button>
                    <div class="nav-tooltip">ÈáçÁΩÆÂßøÊÄÅ</div>
                </div>
                <div class="nav-tool">
                    <button class="nav-icon-btn" onclick="window.open('api_documentation.html', '_blank')"><i data-lucide="book" class="nav-icon-book"></i></button>
                    <div class="nav-tooltip">ÂºÄÂèëÊñáÊ°£</div>
                </div>
                <div class="nav-tool">
                    <button class="nav-icon-btn" id="axisInvertBtn"><i data-lucide="sliders-horizontal"></i></button>
                    <div class="nav-tooltip">Axis Invert</div>
                </div>
            </div>
        </nav>

        <!-- ‰∏ªÂ∏ÉÂ±Ä -->
        <div class="main-layout">
            <!-- Â∑¶‰æß Telemetry -->
            <aside class="sidebar-col">
                <div class="card imu-card" id="imu-card">
                    <div class="imu-header">
                        <div class="imu-title">IMU ÂéüÂßãÊï∞ÊçÆ</div>
                        <select id="sensorSelector" class="sensor-select">
                            <option value="all">ÂÖ®ÈÉ®</option>
                            <option value="gyro">ÈôÄËû∫‰ª™</option>
                            <option value="acc">Âä†ÈÄüÂ∫¶ËÆ°</option>
                            <option value="mag">Á£ÅÂäõËÆ°</option>
                        </select>
                        <button class="view-toggle-btn" id="toggleBtn" title="ÂàáÊç¢ÂõæË°®/Ë°®Ê†º">
                            <svg id="icon-chart" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                            </svg>
                            <svg id="icon-table" width="16" height="16" style="display:none;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="8" y1="6" x2="21" y2="6"></line>
                                <line x1="8" y1="12" x2="21" y2="12"></line>
                                <line x1="8" y1="18" x2="21" y2="18"></line>
                                <line x1="3" y1="6" x2="3.01" y2="6"></line>
                                <line x1="3" y1="12" x2="3.01" y2="12"></line>
                                <line x1="3" y1="18" x2="3.01" y2="18"></line>
                            </svg>
                        </button>
                    </div>

                    <div class="content-wrapper">
                        <div class="table-view">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th style="width: 20%"></th>
                                        <th class="col-x">X</th>
                                        <th class="col-y">Y</th>
                                        <th class="col-z">Z</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td>GYRO</td><td id="t-g-x">0</td><td id="t-g-y">0</td><td id="t-g-z">0</td></tr>
                                    <tr><td>ACC</td><td id="t-a-x">0</td><td id="t-a-y">0</td><td id="t-a-z">0</td></tr>
                                    <tr><td>MAG</td><td id="t-m-x">0</td><td id="t-m-y">0</td><td id="t-m-z">0</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="chart-view" id="chartViewContainer" data-filter="all">
                            <div class="mini-chart-row row-gyro">
                                <div class="chart-header">
                                    <span style="font-weight:600;">GYRO</span>
                                    <div>
                                        <span class="live-val val-x" id="c-g-x">0</span>
                                        <span class="live-val val-y" id="c-g-y">0</span>
                                        <span class="live-val val-z" id="c-g-z">0</span>
                                    </div>
                                </div>
                                <div class="chart-canvas-container">
                                    <canvas id="canvas-gyro"></canvas>
                                </div>
                            </div>

                            <div class="mini-chart-row row-acc">
                                <div class="chart-header">
                                    <span style="font-weight:600;">ACC</span>
                                    <div>
                                        <span class="live-val val-x" id="c-a-x">0</span>
                                        <span class="live-val val-y" id="c-a-y">0</span>
                                        <span class="live-val val-z" id="c-a-z">0</span>
                                    </div>
                                </div>
                                <div class="chart-canvas-container">
                                    <canvas id="canvas-acc"></canvas>
                                </div>
                            </div>

                            <div class="mini-chart-row row-mag">
                                <div class="chart-header">
                                    <span style="font-weight:600;">MAG</span>
                                    <div>
                                        <span class="live-val val-x" id="c-m-x">0</span>
                                        <span class="live-val val-y" id="c-m-y">0</span>
                                        <span class="live-val val-z" id="c-m-z">0</span>
                                    </div>
                                </div>
                                <div class="chart-canvas-container">
                                    <canvas id="canvas-mag"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </aside>

            <!-- ‰∏≠Èó¥ 3D -->
            <section class="center-stage">
                <div id="canvas-container"></div>
                <div class="att-widget-container">
                    <div class="att-nano-widget" id="att-widget" title="ÁÇπÂáªÂàáÊç¢ Á∫øÊÄß/3D ËßÜÂõæ">
                        <div class="view-layer view-linear">
                            <div class="linear-row">
                                <div class="row-head">
                                    <span class="lbl">Roll</span>
                                    <span class="val" id="att-roll-text">0.0¬∞</span>
                                </div>
                                <div class="bar-track">
                                    <div class="center-mark"></div>
                                    <div class="bar-fill" id="att-roll-bar"></div>
                                </div>
                            </div>
                            <div class="linear-row">
                                <div class="row-head">
                                    <span class="lbl">Pitch</span>
                                    <span class="val" id="att-pitch-text">0.0¬∞</span>
                                </div>
                                <div class="bar-track">
                                    <div class="center-mark"></div>
                                    <div class="bar-fill" id="att-pitch-bar"></div>
                                </div>
                            </div>
                            <div class="linear-row">
                                <div class="row-head">
                                    <span class="lbl">Yaw</span>
                                    <span class="val" id="att-yaw-text">0¬∞</span>
                                </div>
                                <div class="bar-track">
                                    <div class="bar-fill" id="att-yaw-bar" style="width:0%"></div>
                                </div>
                            </div>
                        </div>

                        <div class="view-layer view-3d">
                            <canvas id="att-canvas" width="180" height="180"></canvas>
                            <div class="data-3d-row">
                                <div class="d-item"><span class="d-lbl">R</span><span class="d-val" id="att-3d-roll">0</span></div>
                                <div class="d-item"><span class="d-lbl">P</span><span class="d-val" id="att-3d-pitch">0</span></div>
                                <div class="d-item" style="color:var(--att-primary)"><span class="d-lbl" style="color:var(--att-primary)">Y</span><span class="d-val" id="att-3d-yaw">0</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="axis-gizmo">
                    <span class="giz-x">X</span>
                    <span class="giz-y">Y</span>
                    <span class="giz-z">Z</span>
                </div>
                <div class="toast-container canvas-toast" id="toast-container"></div>
                <div class="axis-invert-pop" id="axisInvertPop">
                    <label><input type="checkbox" id="invertRoll"> Roll</label>
                    <label><input type="checkbox" id="invertPitch"> Pitch</label>
                    <label><input type="checkbox" id="invertYaw" checked> Yaw</label>
                </div>
            </section>

            <!-- Âè≥‰æß RC -->
            <aside class="sidebar-col">
                <div class="monitor-card offline" id="rc-monitor">
                    <div class="card-header">
                        <div class="header-title">RC INPUT</div>
                        <div class="signal-badge">
                            <span class="dot-anim"></span>
                            <span id="rc-status-text">DISCONNECTED</span>
                        </div>
                    </div>

                    <div class="gimbals-wrapper">
                        <div class="gimbal-unit">
                            <div class="axis-mark am-h"></div><div class="axis-mark am-v"></div>
                            <div class="stick-dot" id="stick-l"></div>
                            <div class="axis-label lbl-y-top">THR</div>
                            <div class="axis-label lbl-x-right">YAW</div>
                        </div>
                        <div class="gimbal-unit">
                            <div class="axis-mark am-h"></div><div class="axis-mark am-v"></div>
                            <div class="stick-dot" id="stick-r"></div>
                            <div class="axis-label lbl-y-top">PIT</div>
                            <div class="axis-label lbl-x-right">ROL</div>
                        </div>
                    </div>

                    <div class="data-panel">
                        <div class="switch-grid">
                            <div class="sw-col" id="sw1"><div class="sw-name">ARM</div><div class="led-stack"><div class="led-seg seg-h"></div><div class="led-seg seg-m"></div><div class="led-seg seg-l"></div></div></div>
                            <div class="sw-col" id="sw2"><div class="sw-name">MODE</div><div class="led-stack"><div class="led-seg seg-h"></div><div class="led-seg seg-m"></div><div class="led-seg seg-l"></div></div></div>
                            <div class="sw-col" id="sw3"><div class="sw-name">AUX1</div><div class="led-stack"><div class="led-seg seg-h"></div><div class="led-seg seg-m"></div><div class="led-seg seg-l"></div></div></div>
                            <div class="sw-col" id="sw4"><div class="sw-name">AUX2</div><div class="led-stack"><div class="led-seg seg-h"></div><div class="led-seg seg-m"></div><div class="led-seg seg-l"></div></div></div>
                        </div>

                        <div class="channel-list">
                            <div class="ch-item"><div class="ch-info"><span class="ch-name">THR</span><span class="ch-num" id="txt-thr">1000</span></div><div class="bar-container"><div class="bar-fill" id="bar-thr"></div></div></div>
                            <div class="ch-item"><div class="ch-info"><span class="ch-name">YAW</span><span class="ch-num" id="txt-yaw">1500</span></div><div class="bar-container"><div class="bar-fill" id="bar-yaw"></div></div></div>
                            <div class="ch-item"><div class="ch-info"><span class="ch-name">PIT</span><span class="ch-num" id="txt-pit">1500</span></div><div class="bar-container"><div class="bar-fill" id="bar-pit"></div></div></div>
                            <div class="ch-item"><div class="ch-info"><span class="ch-name">ROL</span><span class="ch-num" id="txt-rol">1500</span></div><div class="bar-container"><div class="bar-fill" id="bar-rol"></div></div></div>
                        </div>
                    </div>

                    <div class="footer-status">
                        <span>Protocol: CRSF/S.Bus</span>
                        <span class="hz-counter">Rate: <span id="hz-val">0</span> Hz</span>
                    </div>
                </div>

            </aside>
        </div>
    </div>

    <!-- Â∫ïÈÉ®‰∏≤Âè£ËæìÂá∫ -->
    <div class="console-drawer closed" id="console-drawer">
        <div class="console-header">
            <div style="display:flex;align-items:center;gap:8px;font-weight:700">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 17 10 11 4 5"></polyline><line x1="12" y1="19" x2="20" y2="19"></line></svg>
                SERIAL OUTPUT
            </div>
            <div class="console-ops">
                <label class="opt-label"><input type="checkbox" id="chk-scroll" checked> Auto-Scroll</label>
                <label class="opt-label"><input type="checkbox" id="chk-ts" checked> Time</label>
                <label class="opt-label"><input type="checkbox" id="chk-throttle" checked> Throttle</label>
                <button class="btn btn-ghost" style="height:24px;padding:0 8px" onclick="document.getElementById('console-body').innerHTML = '';">Clear</button>
            </div>
        </div>
        <div class="console-body" id="console-body">
            <div class="log-line"><span class="log-sys">Console ready. Waiting for connection...</span></div>
        </div>
    </div>

    <!-- ÂùêÊ†áÁ≥ªË∞ÉËØïÈù¢Êùø -->
    <div id="coordDebugPanel" class="debug-panel hidden">
        <h3>üîß ÂùêÊ†áÁ≥ªË∞ÉËØï</h3>
        <div class="debug-info">
            <p><strong>È£ûÊéßÂùêÊ†áÁ≥ª (FLU)Ôºö</strong></p>
            <ul>
                <li>üîµ ËìùËâ≤ÁÆ≠Â§¥ = <strong>XËΩ¥</strong>ÔºàÊ≠£Èù¢/ÂâçÔºâ</li>
                <li>üî¥ Á∫¢Ëâ≤ÁÆ≠Â§¥ = <strong>YËΩ¥</strong>ÔºàÂ∑¶ËæπÔºâ</li>
                <li>üü¢ ÁªøËâ≤ÁÆ≠Â§¥ = <strong>ZËΩ¥</strong>Ôºà‰∏äÔºâ</li>
            </ul>
            <p><strong>Ê®°ÂûãÂÖ∂‰ªñÊ†áËØÜÔºö</strong></p>
            <ul>
                <li>üîµ ËìùËâ≤ÈïúÂ§¥ = Êú∫Â§¥ÊúùÂêë</li>
                <li>üî¥ Á∫¢Ëâ≤LED = Ââç‰æßËû∫ÊóãÊ°®</li>
                <li>üü¢ ÁªøËâ≤LED = Âêé‰æßËû∫ÊóãÊ°®</li>
            </ul>
            <p><strong>ÊµãËØïÊ≠•È™§Ôºö</strong></p>
            <ol>
                <li><strong>RollÊµãËØïÔºö</strong>ÂêëÂè≥ÂÄæÊñúÈ£ûÊéß ‚Üí Ê®°ÂûãÁ∫¢ÁÅØÂ∫î‰∏ãÊ≤â</li>
                <li><strong>PitchÊµãËØïÔºö</strong>Êä¨Ëµ∑Êú∫Â§¥ ‚Üí ÁªøÁÆ≠Â§¥Â∫îÂêë‰∏ä</li>
                <li><strong>YawÊµãËØïÔºö</strong>È°∫Êó∂ÈíàÊóãËΩ¨ ‚Üí Ê®°ÂûãÂ∫îÈ°∫Êó∂ÈíàËΩ¨</li>
            </ol>
            <div class="coord-adjust">
                <label><input type="checkbox" id="invertRoll"> ÂèçËΩ¨Roll</label>
                <label><input type="checkbox" id="invertPitch"> ÂèçËΩ¨Pitch</label>
                <label><input type="checkbox" id="invertYaw" checked> ÂèçËΩ¨Yaw</label>
            </div>
            <div class="realtime-debug">
                <p><strong>ÂÆûÊó∂ÂßøÊÄÅËßíÔºö</strong></p>
                <div style="font-family: monospace; font-size: 0.85rem;">
                    Roll:  <span id="debug-roll">0</span>¬∞<br>
                    Pitch: <span id="debug-pitch">0</span>¬∞<br>
                    Yaw:   <span id="debug-yaw">0</span>¬∞
                </div>
            </div>
        </div>
        <button class="btn btn-secondary" onclick="toggleCoordDebug()">ÂÖ≥Èó≠</button>
    </div>

    <!-- Á£ÅÂäõËÆ°Ê†°ÂáÜÊ®°ÊÄÅÊ°Ü -->
    <div id="magCalibModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i data-lucide="compass"></i> Á£ÅÂäõËÆ°Ê†°ÂáÜ</h2>
                <button class="modal-close" onclick="closeMagCalibModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="calib-step-1" class="calib-step">
                    <h3>üìã ÂáÜÂ§áÂ∑•‰Ωú</h3>
                    <ul class="calib-instructions">
                        <li>‚úì Á°Æ‰øù‰∏≤Âè£Â∑≤ËøûÊé•</li>
                        <li>‚úì ËøúÁ¶ªÁîµËÑë„ÄÅÊâãÊú∫„ÄÅÈáëÂ±ûÊ°åÈù¢Á≠âÁ£ÅÂú∫Ê∫ê</li>
                        <li>‚úì ÂáÜÂ§áÂú®60ÁßíÂÜÖÁºìÊÖ¢ÊóãËΩ¨ËÆæÂ§á</li>
                        <li>‚úì ÊóãËΩ¨ÊñπÂºèÔºöÊ∞¥Âπ≥360¬∞„ÄÅÂâçÂêéÁøªËΩ¨„ÄÅÂ∑¶Âè≥ÁøªËΩ¨„ÄÅ8Â≠óÂΩ¢</li>
                    </ul>
                    <button class="btn btn-primary" onclick="startMagCalibration()">
                        <i data-lucide="play"></i> ÂºÄÂßãÊ†°ÂáÜ
                    </button>
                </div>

                <div id="calib-step-2" class="calib-step hidden">
                    <h3>üîÑ Ê≠£Âú®ÈááÈõÜÊï∞ÊçÆ...</h3>
                    <p class="calib-tip">ËØ∑ÁºìÊÖ¢ÊóãËΩ¨ËÆæÂ§á60ÁßíÔºåË¶ÜÁõñÊâÄÊúâÊñπÂêëÔºÅ</p>
                    <div class="progress-bar">
                        <div id="calib-progress" class="progress-fill"></div>
                    </div>
                    <p class="progress-text">
                        <span id="calib-time">0</span>s / 60s | 
                        Ê†∑Êú¨Êï∞: <span id="calib-samples">0</span>
                    </p>
                    <div class="mag-range">
                        <div>X: [<span id="mx-min">--</span>, <span id="mx-max">--</span>]</div>
                        <div>Y: [<span id="my-min">--</span>, <span id="my-max">--</span>]</div>
                        <div>Z: [<span id="mz-min">--</span>, <span id="mz-max">--</span>]</div>
                    </div>
                    <div class="mag-plot-wrapper">
                        <canvas id="magPlot" width="520" height="450"></canvas>
                        <div class="legend">
                            <span><span class="legend-dot" style="background:#ff6b35; color:#ff6b35"></span> ÂéüÂßãÊï∞ÊçÆ</span>
                            <span><span class="legend-dot" style="background:#00ff88; color:#00ff88"></span> Ê†°ÂáÜÂêé</span>
                        </div>
                    </div>
                </div>

                <div id="calib-step-3" class="calib-step hidden">
                    <h3>‚úÖ Ê†°ÂáÜÂÆåÊàê</h3>
                    <div class="calib-result">
                        <h4>üìä Ê†°ÂáÜÂèÇÊï∞</h4>
                        <div class="param-grid">
                            <div class="param-item">
                                <label>Á°¨ÈìÅÂÅèÁΩÆ (Offset):</label>
                                <div class="param-values">
                                    <span>X: <code id="offset-x">0</code></span>
                                    <span>Y: <code id="offset-y">0</code></span>
                                    <span>Z: <code id="offset-z">0</code></span>
                                </div>
                            </div>
                            <div class="param-item">
                                <label>ËΩØÈìÅÁº©Êîæ (Scale):</label>
                                <div class="param-values">
                                    <span>X: <code id="scale-x">1.000</code></span>
                                    <span>Y: <code id="scale-y">1.000</code></span>
                                    <span>Z: <code id="scale-z">1.000</code></span>
                                </div>
                            </div>
                        </div>
                        
                        <h4>üìã Â§çÂà∂‰ª£Á†ÅÂà∞ÂçïÁâáÊú∫</h4>
                        <pre id="calib-code" class="code-block">mag_set_calibration(
    0.0f, 0.0f, 0.0f,    // offset_x, offset_y, offset_z
    1.0f, 1.0f, 1.0f     // scale_x, scale_y, scale_z
);</pre>
                        <div class="btn-group">
                            <button class="btn btn-copy" onclick="copyCalibCode()">
                                <i data-lucide="copy"></i> Â§çÂà∂‰ª£Á†Å
                            </button>
                            <button class="btn btn-export" onclick="exportMagData('csv')">
                                <i data-lucide="download"></i> ÂØºÂá∫CSV
                            </button>
                            <button class="btn btn-export" onclick="exportMagData('json')">
                                <i data-lucide="file-json"></i> ÂØºÂá∫JSON
                            </button>
                        </div>
                        
                        <h4>üìà Ê†°ÂáÜË¥®Èáè</h4>
                        <div id="calib-quality" class="quality-badge">--</div>
                        <p id="calib-tips" class="calib-tips"></p>
                    </div>
                    <button class="btn btn-primary" onclick="closeMagCalibModal()">ÂÆåÊàê</button>
                    <button class="btn btn-secondary" onclick="resetMagCalibration()">ÈáçÊñ∞Ê†°ÂáÜ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts / Critical modal -->
    <div class="hud-alert-container" id="hud-alert">
        <div class="hud-badge">
            <svg class="hud-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
            <span id="hud-text">System Ready</span>
        </div>
    </div>

    <div class="modal-overlay" id="critical-modal">
        <div class="error-card">
            <div class="ec-header">
                <div class="ec-icon-box">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18.42 2.11A3 3 0 0 0 16.3 1.23H7.7a3 3 0 0 0-2.12.88l-4.7 4.7a3 3 0 0 0-.88 2.12v8.6a3 3 0 0 0 .88 2.12l4.7 4.7a3 3 0 0 0 2.12.88h8.6a3 3 0 0 0 2.12-.88l4.7-4.7a3 3 0 0 0 .88-2.12V8.93a3 3 0 0 0-.88-2.12z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                </div>
                <div class="ec-title-group">
                    <div class="ec-title" id="ec-title">Critical Failure</div>
                    <div class="ec-subtitle" id="ec-subtitle">Flight Controller Halted</div>
                </div>
            </div>
            <div class="ec-body">
                <div class="ec-msg" id="ec-message">
                    The IMU sensor is not responding. The system has triggered failsafe mode to prevent unstable flight behavior.
                </div>
                <div class="error-code-box">
                    <span>ERR_CODE:</span>
                    <span id="ec-code">--</span>
                </div>
            </div>
            <div class="ec-actions">
                <button class="alert-btn alert-btn-ghost" id="ec-ignore">Ignore</button>
                <button class="alert-btn alert-btn-danger" id="ec-stop">Emergency Stop</button>
            </div>
        </div>
    </div>

    <!-- ÁîµÊú∫ÂÆâÂÖ®Á°ÆËÆ§ÂºπÁ™ó -->
    <div class="safety-modal modal-overlay hidden" id="motorSafetyModal">
        <div class="safety-card" id="motorSafetyCard">
            <button class="safety-close" id="motorSafetyClose">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            
            <!-- Ë∂ÖÂ§ßÂõæÊ†áÂå∫ -->
            <div class="icon-wrapper">
                <div class="wave"></div>
                <div class="wave"></div>
                <div class="icon-inner">
                    <svg width="42" height="42" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                </div>
            </div>

            <!-- ÊñáÂ≠óÂå∫ -->
            <div class="safety-body">
                <h2>ÂÆâÂÖ®Ê£ÄÊü•</h2>
                <p>
                    ÁîµÊú∫Âç≥Â∞ÜÈ´òÈÄüÊóãËΩ¨„ÄÇ<br>
                    ËØ∑Âä°ÂøÖÁ°ÆËÆ§ <strong>Â∑≤ÊãÜÈô§ÊâÄÊúâËû∫ÊóãÊ°®</strong>„ÄÇ
                </p>

                <!-- Âπ≤ÂáÄÁöÑÂ§çÈÄâÊ°Ü -->
                <label class="checkbox-row">
                    <input type="checkbox" id="motorSafetyCheck" style="display:none">
                    <div class="custom-check">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                    </div>
                    <span class="check-text">ÊàëÂ∑≤Á°ÆËÆ§ÊãÜÈô§Ëû∫ÊóãÊ°®</span>
                </label>

                <!-- Â∞èÂ∑ßÂúÜÊªëÊåâÈíÆ -->
                <button class="btn-round" id="motorConfirmBtn">
                    ÂºÄÂßãÊµãËØï
                </button>
            </div>
        </div>
    </div>

    <!-- ÁîµÊú∫ÊµãËØïÊ®°ÊÄÅÊ°Ü -->
    <div class="motor-modal modal-overlay hidden" id="motorModal">
        <div class="motor-card">
            <div class="motor-header">
                <div class="motor-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#475569" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                    ÁîµÊú∫ÊµãËØï <span class="motor-badge">Test Mode</span>
                </div>
                <button class="motor-close" onclick="closeMotorModal()">&times;</button>
            </div>
            <div class="motor-body">
                <div class="drone-stage">
                    <svg class="drone-svg-body" viewBox="0 0 400 400" fill="none">
                        <path d="M170 160 L60 60 L70 50 L180 150 Z" fill="#475569" stroke="#1E293B" stroke-width="2"/>
                        <path d="M230 160 L340 60 L330 50 L220 150 Z" fill="#475569" stroke="#1E293B" stroke-width="2"/>
                        <path d="M170 240 L60 340 L70 350 L180 250 Z" fill="#475569" stroke="#1E293B" stroke-width="2"/>
                        <path d="M230 240 L340 340 L330 350 L220 250 Z" fill="#475569" stroke="#1E293B" stroke-width="2"/>
                        <rect x="160" y="140" width="80" height="120" rx="20" fill="#334155" />
                        <rect x="170" y="150" width="60" height="100" rx="15" fill="#1E293B" />
                        <path d="M 185 140 L 190 125 C 190 120, 210 120, 210 125 L 215 140 Z" fill="#94A3B8" stroke="#64748B" stroke-width="1.5"/>
                        <rect x="150" y="190" width="100" height="20" rx="4" fill="#0EA5E9" fill-opacity="0.9"/>
                    </svg>

                    <div class="motor-trigger pos-fl dir-cw" onclick="toggleMotor(this)">
                        <svg class="arrow-ring-layer" viewBox="0 0 100 100">
                            <path class="ring-track" d="M 14 50 A 36 36 0 0 1 48 14.5" stroke="currentColor" fill="none" />
                            <path class="ring-arrow-head" d="M 44 6 L 60 14.5 L 44 23 Z" fill="currentColor" />
                        </svg>
                        <div class="motor-unit"><span class="motor-num">4</span><div class="motor-coil"></div></div>
                        <div class="prop-layer"><svg viewBox="0 0 100 100" width="100%" height="100%"><g transform="translate(50,50)"><path class="prop-shape" d="M-5 0 Q -10 -40 0 -45 Q 10 -40 5 0 Z" /><path class="prop-tip" d="M-2 -35 Q 0 -45 2 -35 Z" transform="translate(0, -5) scale(2)"/><path class="prop-shape" d="M-5 0 Q -10 40 0 45 Q 10 40 5 0 Z" /><path class="prop-tip" d="M-2 35 Q 0 45 2 35 Z" transform="translate(0, 5) scale(2)"/></g></svg></div>
                    </div>

                    <div class="motor-trigger pos-fr dir-ccw" onclick="toggleMotor(this)">
                        <svg class="arrow-ring-layer" viewBox="0 0 100 100">
                            <path class="ring-track" d="M 86 50 A 36 36 0 0 0 52 14.5" stroke="currentColor" fill="none" />
                            <path class="ring-arrow-head" d="M 56 6 L 40 14.5 L 56 23 Z" fill="currentColor" />
                        </svg>
                        <div class="motor-unit"><span class="motor-num">2</span><div class="motor-coil"></div></div>
                        <div class="prop-layer"><svg viewBox="0 0 100 100" width="100%" height="100%"><g transform="translate(50,50)"><path class="prop-shape" d="M-5 0 Q -10 -40 0 -45 Q 10 -40 5 0 Z" /><path class="prop-tip" d="M-2 -35 Q 0 -45 2 -35 Z" transform="translate(0, -5) scale(2)"/><path class="prop-shape" d="M-5 0 Q -10 40 0 45 Q 10 40 5 0 Z" /><path class="prop-tip" d="M-2 35 Q 0 45 2 35 Z" transform="translate(0, 5) scale(2)"/></g></svg></div>
                    </div>

                    <div class="motor-trigger pos-rl dir-ccw" onclick="toggleMotor(this)">
                        <svg class="arrow-ring-layer" viewBox="0 0 100 100">
                            <path class="ring-track" d="M 14 50 A 36 36 0 0 0 48 85.5" stroke="currentColor" fill="none" />
                            <path class="ring-arrow-head" d="M 44 77 L 60 85.5 L 44 94 Z" fill="currentColor" />
                        </svg>
                        <div class="motor-unit"><span class="motor-num">3</span><div class="motor-coil"></div></div>
                        <div class="prop-layer"><svg viewBox="0 0 100 100" width="100%" height="100%"><g transform="translate(50,50)"><path class="prop-shape" d="M-5 0 Q -10 -40 0 -45 Q 10 -40 5 0 Z" /><path class="prop-tip" d="M-2 -35 Q 0 -45 2 -35 Z" transform="translate(0, -5) scale(2)"/><path class="prop-shape" d="M-5 0 Q -10 40 0 45 Q 10 40 5 0 Z" /><path class="prop-tip" d="M-2 35 Q 0 45 2 35 Z" transform="translate(0, 5) scale(2)"/></g></svg></div>
                    </div>

                    <div class="motor-trigger pos-rr dir-cw" onclick="toggleMotor(this)">
                        <svg class="arrow-ring-layer" viewBox="0 0 100 100">
                            <path class="ring-track" d="M 86 50 A 36 36 0 0 1 52 85.5" stroke="currentColor" fill="none" />
                            <path class="ring-arrow-head" d="M 56 77 L 40 85.5 L 56 94 Z" fill="currentColor" />
                        </svg>
                        <div class="motor-unit"><span class="motor-num">1</span><div class="motor-coil"></div></div>
                        <div class="prop-layer"><svg viewBox="0 0 100 100" width="100%" height="100%"><g transform="translate(50,50)"><path class="prop-shape" d="M-5 0 Q -10 -40 0 -45 Q 10 -40 5 0 Z" /><path class="prop-tip" d="M-2 -35 Q 0 -45 2 -35 Z" transform="translate(0, -5) scale(2)"/><path class="prop-shape" d="M-5 0 Q -10 40 0 45 Q 10 40 5 0 Z" /><path class="prop-tip" d="M-2 35 Q 0 45 2 35 Z" transform="translate(0, 5) scale(2)"/></g></svg></div>
                    </div>
                </div>

                <div class="modal-footer motor-footer">
                    <button class="btn-main btn-start" id="masterBtn" onclick="toggleMaster()">ÂêØÂä®ÂÖ®ÈÉ®ÁîµÊú∫</button>
                    <button class="btn-main btn-stop" onclick="closeMotorModal()">ÂÖ≥Èó≠</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Ê®°Âùó -->
    <script src="js/config.js"></script>
    <script src="js/ui-sidebar.js"></script>
    <script src="js/ui-rc-monitor.js"></script>
    <script src="js/ui-alerts.js"></script>
    <script src="js/ui-imu-card.js"></script>
    <script src="js/attitude-widget.js"></script>
    <script src="js/serial.js"></script>
    <script src="js/motor-modal.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/recording.js"></script>
    <script src="js/mag-calibration.js"></script>
    <script src="js/attitude-reset.js"></script>
    <script src="js/orientation.js"></script>
    <script src="js/scene.js"></script>
    <script src="js/drone.js"></script>
    <script src="js/app.js"></script>
    <script>
        // Console drawer toggle + resize (min/max clamp)
        document.addEventListener('DOMContentLoaded', () => {
            const drawer = document.getElementById('console-drawer');
            const header = drawer?.querySelector('.console-header');
            const minH = 120;
            const maxH = 400;
            let startY = 0;
            let startH = 0;
            let dragging = false;

            const setHeight = (h) => {
                const clamped = Math.max(minH, Math.min(maxH, h));
                drawer.style.setProperty('--console-height', `${clamped}px`);
                if (drawer.classList.contains('closed')) {
                    drawer.classList.add('closed'); // reapply transform with new height
                }
            };

            const endDrag = (toggleIfClick) => {
                if (!dragging) return;
                dragging = false;
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onUp);
                if (toggleIfClick) {
                    drawer.classList.toggle('closed');
                }
            };

            const onMove = (e) => {
                if (!dragging) return;
                const delta = startY - e.clientY;
                setHeight(startH + delta);
            };
            const onUp = (e) => {
                const delta = Math.abs(startY - e.clientY);
                endDrag(delta < 3);
            };

            if (drawer && header) {
                header.addEventListener('mousedown', (e) => {
                    if (e.target.closest('.console-ops')) return;
                    if (e.target.closest('input,button')) return;
                    startY = e.clientY;
                    startH = drawer.getBoundingClientRect().height;
                    dragging = true;
                    document.addEventListener('mousemove', onMove);
                    document.addEventListener('mouseup', onUp);
                });
            }
        });
        lucide.createIcons();
    </script>
</body>
</html>
