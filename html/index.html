<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Drone Visualizer</title>
    
    <!-- æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/new-ui.css">
    <link rel="stylesheet" href="styles/layout.css">
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Three.js æ ¸å¿ƒåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>

    <div class="app-shell">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <nav class="top-bar">
            <div class="brand">
                <div class="brand-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg></div>
                <span>AERO VISUALIZER</span>
            </div>

            <div class="status-strip">
                <div class="vital-item">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="6" width="18" height="12" rx="2" ry="2"></rect><line x1="23" y1="13" x2="23" y2="11"></line></svg>
                    <span class="vital-val" id="val-imu-temp">--</span>Â°C
                </div>
                <div class="vital-item" style="border-left:1px solid var(--border); padding-left:16px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12.55a11 11 0 0 1 14.08 0"></path><path d="M1.42 9a16 16 0 0 1 21.16 0"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line></svg>
                    <span class="vital-val" id="status-text">Disconnected</span>
                </div>
            </div>

            <button id="connectBtn" class="btn btn-primary">
                <span class="status-dot" id="status-dot"></span>
                <span>è¿æ¥ä¸²å£</span>
            </button>
            <div class="tool-actions">
                <button id="recordBtn" class="btn btn-danger hidden"><i data-lucide="circle-dot"></i> å¼€å§‹å½•åˆ¶</button>
                <button id="magCalibBtn" class="btn btn-ghost" onclick="openMagCalibModal()"><i data-lucide="compass"></i></button>
                <button id="motorTestBtn" class="btn btn-ghost"><i data-lucide="fan"></i></button>
                <button id="resetAttitudeBtn" class="btn btn-ghost" onclick="resetAttitude()"><i data-lucide="rotate-ccw"></i></button>
                <button class="btn btn-ghost" onclick="window.open('api_documentation.html', '_blank')"><i data-lucide="book-open"></i></button>
            </div>
        </nav>

        <!-- ä¸»å¸ƒå±€ -->
        <div class="main-layout">
            <!-- å·¦ä¾§ Telemetry -->
            <aside class="sidebar-col">
                <div class="card imu-card" id="imu-card">
                    <div class="imu-header">
                        <div class="imu-title">IMU åŸå§‹æ•°æ®</div>
                        <select id="sensorSelector" class="sensor-select">
                            <option value="all">å…¨éƒ¨</option>
                            <option value="gyro">é™€èºä»ª</option>
                            <option value="acc">åŠ é€Ÿåº¦è®¡</option>
                            <option value="mag">ç£åŠ›è®¡</option>
                        </select>
                        <button class="view-toggle-btn" id="toggleBtn" title="åˆ‡æ¢å›¾è¡¨/è¡¨æ ¼">
                            <svg id="icon-chart" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                            </svg>
                            <svg id="icon-table" width="16" height="16" style="display:none;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="8" y1="6" x2="21" y2="6"></line>
                                <line x1="8" y1="12" x2="21" y2="12"></line>
                                <line x1="8" y1="18" x2="21" y2="18"></line>
                                <line x1="3" y1="6" x2="3.01" y2="6"></line>
                                <line x1="3" y1="12" x2="3.01" y2="12"></line>
                                <line x1="3" y1="18" x2="3.01" y2="18"></line>
                            </svg>
                        </button>
                    </div>

                    <div class="content-wrapper">
                        <div class="table-view">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th style="width: 20%"></th>
                                        <th class="col-x">X</th>
                                        <th class="col-y">Y</th>
                                        <th class="col-z">Z</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td>GYRO</td><td id="t-g-x">0</td><td id="t-g-y">0</td><td id="t-g-z">0</td></tr>
                                    <tr><td>ACC</td><td id="t-a-x">0</td><td id="t-a-y">0</td><td id="t-a-z">0</td></tr>
                                    <tr><td>MAG</td><td id="t-m-x">0</td><td id="t-m-y">0</td><td id="t-m-z">0</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="chart-view" id="chartViewContainer" data-filter="all">
                            <div class="mini-chart-row row-gyro">
                                <div class="chart-header">
                                    <span style="font-weight:600;">GYRO</span>
                                    <div>
                                        <span class="live-val val-x" id="c-g-x">0</span>
                                        <span class="live-val val-y" id="c-g-y">0</span>
                                        <span class="live-val val-z" id="c-g-z">0</span>
                                    </div>
                                </div>
                                <div class="chart-canvas-container">
                                    <canvas id="canvas-gyro"></canvas>
                                </div>
                            </div>

                            <div class="mini-chart-row row-acc">
                                <div class="chart-header">
                                    <span style="font-weight:600;">ACC</span>
                                    <div>
                                        <span class="live-val val-x" id="c-a-x">0</span>
                                        <span class="live-val val-y" id="c-a-y">0</span>
                                        <span class="live-val val-z" id="c-a-z">0</span>
                                    </div>
                                </div>
                                <div class="chart-canvas-container">
                                    <canvas id="canvas-acc"></canvas>
                                </div>
                            </div>

                            <div class="mini-chart-row row-mag">
                                <div class="chart-header">
                                    <span style="font-weight:600;">MAG</span>
                                    <div>
                                        <span class="live-val val-x" id="c-m-x">0</span>
                                        <span class="live-val val-y" id="c-m-y">0</span>
                                        <span class="live-val val-z" id="c-m-z">0</span>
                                    </div>
                                </div>
                                <div class="chart-canvas-container">
                                    <canvas id="canvas-mag"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="section-header">Attitude</div>
                    <div class="angle-row">
                        <div class="angle-info"><span>Roll</span><span class="angle-num" id="att-r">0.0Â°</span></div>
                        <div class="vis-bar-track"><div class="vis-bar-fill" id="vis-r"></div></div>
                    </div>
                    <div class="angle-row">
                        <div class="angle-info"><span>Pitch</span><span class="angle-num" id="att-p">0.0Â°</span></div>
                        <div class="vis-bar-track"><div class="vis-bar-fill" id="vis-p"></div></div>
                    </div>
                    <div class="angle-row">
                        <div class="angle-info"><span>Yaw</span><span class="angle-num" id="att-y">0Â°</span></div>
                        <div class="vis-bar-track"><div class="vis-bar-fill" id="vis-y" style="left:0"></div></div>
                    </div>
                </div>


                <div class="card">
                    <div class="section-header">æµ‹è·ä¼ æ„Ÿå™¨</div>
                    <div class="tof-panel is-offline" id="tof-panel">
                        <div class="tof-icon">ToF</div>
                        <div class="tof-data">
                            <div class="tof-label">
                                DISTANCE
                            </div>
                            <div class="tof-val-group">
                                <span class="tof-val" id="tof-val">--</span>
                                <span class="tof-unit">mm</span>
                            </div>
                            <div class="tof-bar-bg">
                                <div class="tof-bar-fill" id="tof-bar"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="section-header">Environment</div>
                    <div class="sensor-grid">
                        <div class="env-item">
                            <span class="env-l">Temp</span>
                            <span class="env-v"><span id="val-temp">--</span>Â°C</span>
                        </div>
                        <div class="env-item">
                            <span class="env-l">Pressure</span>
                            <span class="env-v"><span id="val-baro">--</span>hPa</span>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- ä¸­é—´ 3D -->
            <section class="center-stage">
                <div id="canvas-container"></div>
                <div class="axis-gizmo">
                    <span class="giz-x">X</span>
                    <span class="giz-y">Y</span>
                    <span class="giz-z">Z</span>
                </div>
                <div class="toast-container canvas-toast" id="toast-container"></div>
            </section>

            <!-- å³ä¾§ RC -->
            <aside class="sidebar-col">
                <div class="monitor-card offline" id="rc-monitor">
                    <div class="card-header">
                        <div class="header-title">RC INPUT</div>
                        <div class="signal-badge">
                            <span class="dot-anim"></span>
                            <span id="rc-status-text">DISCONNECTED</span>
                        </div>
                    </div>

                    <div class="gimbals-wrapper">
                        <div class="gimbal-unit">
                            <div class="axis-mark am-h"></div><div class="axis-mark am-v"></div>
                            <div class="stick-dot" id="stick-l"></div>
                            <div class="axis-label lbl-y-top">THR</div>
                            <div class="axis-label lbl-x-right">YAW</div>
                        </div>
                        <div class="gimbal-unit">
                            <div class="axis-mark am-h"></div><div class="axis-mark am-v"></div>
                            <div class="stick-dot" id="stick-r"></div>
                            <div class="axis-label lbl-y-top">PIT</div>
                            <div class="axis-label lbl-x-right">ROL</div>
                        </div>
                    </div>

                    <div class="data-panel">
                        <div class="switch-grid">
                            <div class="sw-col" id="sw1"><div class="sw-name">ARM</div><div class="led-stack"><div class="led-seg seg-h"></div><div class="led-seg seg-m"></div><div class="led-seg seg-l"></div></div></div>
                            <div class="sw-col" id="sw2"><div class="sw-name">MODE</div><div class="led-stack"><div class="led-seg seg-h"></div><div class="led-seg seg-m"></div><div class="led-seg seg-l"></div></div></div>
                            <div class="sw-col" id="sw3"><div class="sw-name">AUX1</div><div class="led-stack"><div class="led-seg seg-h"></div><div class="led-seg seg-m"></div><div class="led-seg seg-l"></div></div></div>
                            <div class="sw-col" id="sw4"><div class="sw-name">AUX2</div><div class="led-stack"><div class="led-seg seg-h"></div><div class="led-seg seg-m"></div><div class="led-seg seg-l"></div></div></div>
                        </div>

                        <div class="channel-list">
                            <div class="ch-item"><div class="ch-info"><span class="ch-name">THR</span><span class="ch-num" id="txt-thr">1000</span></div><div class="bar-container"><div class="bar-fill" id="bar-thr"></div></div></div>
                            <div class="ch-item"><div class="ch-info"><span class="ch-name">YAW</span><span class="ch-num" id="txt-yaw">1500</span></div><div class="bar-container"><div class="bar-fill" id="bar-yaw"></div></div></div>
                            <div class="ch-item"><div class="ch-info"><span class="ch-name">PIT</span><span class="ch-num" id="txt-pit">1500</span></div><div class="bar-container"><div class="bar-fill" id="bar-pit"></div></div></div>
                            <div class="ch-item"><div class="ch-info"><span class="ch-name">ROL</span><span class="ch-num" id="txt-rol">1500</span></div><div class="bar-container"><div class="bar-fill" id="bar-rol"></div></div></div>
                        </div>
                    </div>

                    <div class="footer-status">
                        <span>Protocol: CRSF/S.Bus</span>
                        <span class="hz-counter">Rate: <span id="hz-val">0</span> Hz</span>
                    </div>
                </div>

                <div class="card">
                    <div class="section-header">Axis Invert</div>
                    <div class="axis-invert-row">
                        <label><input type="checkbox" id="invertRoll"> Roll</label>
                        <label><input type="checkbox" id="invertPitch"> Pitch</label>
                        <label><input type="checkbox" id="invertYaw" checked> Yaw</label>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- åº•éƒ¨ä¸²å£è¾“å‡º -->
    <div class="console-drawer closed" id="console-drawer">
        <div class="console-header">
            <div style="display:flex;align-items:center;gap:8px;font-weight:700">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 17 10 11 4 5"></polyline><line x1="12" y1="19" x2="20" y2="19"></line></svg>
                SERIAL OUTPUT
            </div>
            <div class="console-ops">
                <label class="opt-label"><input type="checkbox" id="chk-scroll" checked> Auto-Scroll</label>
                <label class="opt-label"><input type="checkbox" id="chk-ts" checked> Time</label>
                <label class="opt-label"><input type="checkbox" id="chk-throttle" checked> Throttle</label>
                <button class="btn btn-ghost" style="height:24px;padding:0 8px" onclick="document.getElementById('console-body').innerHTML = '';">Clear</button>
            </div>
        </div>
        <div class="console-body" id="console-body">
            <div class="log-line"><span class="log-sys">Console ready. Waiting for connection...</span></div>
        </div>
    </div>

    <!-- åæ ‡ç³»è°ƒè¯•é¢æ¿ -->
    <div id="coordDebugPanel" class="debug-panel hidden">
        <h3>ğŸ”§ åæ ‡ç³»è°ƒè¯•</h3>
        <div class="debug-info">
            <p><strong>é£æ§åæ ‡ç³» (FLU)ï¼š</strong></p>
            <ul>
                <li>ğŸ”µ è“è‰²ç®­å¤´ = <strong>Xè½´</strong>ï¼ˆæ­£é¢/å‰ï¼‰</li>
                <li>ğŸ”´ çº¢è‰²ç®­å¤´ = <strong>Yè½´</strong>ï¼ˆå·¦è¾¹ï¼‰</li>
                <li>ğŸŸ¢ ç»¿è‰²ç®­å¤´ = <strong>Zè½´</strong>ï¼ˆä¸Šï¼‰</li>
            </ul>
            <p><strong>æ¨¡å‹å…¶ä»–æ ‡è¯†ï¼š</strong></p>
            <ul>
                <li>ğŸ”µ è“è‰²é•œå¤´ = æœºå¤´æœå‘</li>
                <li>ğŸ”´ çº¢è‰²LED = å‰ä¾§èºæ—‹æ¡¨</li>
                <li>ğŸŸ¢ ç»¿è‰²LED = åä¾§èºæ—‹æ¡¨</li>
            </ul>
            <p><strong>æµ‹è¯•æ­¥éª¤ï¼š</strong></p>
            <ol>
                <li><strong>Rollæµ‹è¯•ï¼š</strong>å‘å³å€¾æ–œé£æ§ â†’ æ¨¡å‹çº¢ç¯åº”ä¸‹æ²‰</li>
                <li><strong>Pitchæµ‹è¯•ï¼š</strong>æŠ¬èµ·æœºå¤´ â†’ ç»¿ç®­å¤´åº”å‘ä¸Š</li>
                <li><strong>Yawæµ‹è¯•ï¼š</strong>é¡ºæ—¶é’ˆæ—‹è½¬ â†’ æ¨¡å‹åº”é¡ºæ—¶é’ˆè½¬</li>
            </ol>
            <div class="coord-adjust">
                <label><input type="checkbox" id="invertRoll"> åè½¬Roll</label>
                <label><input type="checkbox" id="invertPitch"> åè½¬Pitch</label>
                <label><input type="checkbox" id="invertYaw" checked> åè½¬Yaw</label>
            </div>
            <div class="realtime-debug">
                <p><strong>å®æ—¶å§¿æ€è§’ï¼š</strong></p>
                <div style="font-family: monospace; font-size: 0.85rem;">
                    Roll:  <span id="debug-roll">0</span>Â°<br>
                    Pitch: <span id="debug-pitch">0</span>Â°<br>
                    Yaw:   <span id="debug-yaw">0</span>Â°
                </div>
            </div>
        </div>
        <button class="btn btn-secondary" onclick="toggleCoordDebug()">å…³é—­</button>
    </div>

    <!-- ç£åŠ›è®¡æ ¡å‡†æ¨¡æ€æ¡† -->
    <div id="magCalibModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i data-lucide="compass"></i> ç£åŠ›è®¡æ ¡å‡†</h2>
                <button class="modal-close" onclick="closeMagCalibModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="calib-step-1" class="calib-step">
                    <h3>ğŸ“‹ å‡†å¤‡å·¥ä½œ</h3>
                    <ul class="calib-instructions">
                        <li>âœ“ ç¡®ä¿ä¸²å£å·²è¿æ¥</li>
                        <li>âœ“ è¿œç¦»ç”µè„‘ã€æ‰‹æœºã€é‡‘å±æ¡Œé¢ç­‰ç£åœºæº</li>
                        <li>âœ“ å‡†å¤‡åœ¨60ç§’å†…ç¼“æ…¢æ—‹è½¬è®¾å¤‡</li>
                        <li>âœ“ æ—‹è½¬æ–¹å¼ï¼šæ°´å¹³360Â°ã€å‰åç¿»è½¬ã€å·¦å³ç¿»è½¬ã€8å­—å½¢</li>
                    </ul>
                    <button class="btn btn-primary" onclick="startMagCalibration()">
                        <i data-lucide="play"></i> å¼€å§‹æ ¡å‡†
                    </button>
                </div>

                <div id="calib-step-2" class="calib-step hidden">
                    <h3>ğŸ”„ æ­£åœ¨é‡‡é›†æ•°æ®...</h3>
                    <p class="calib-tip">è¯·ç¼“æ…¢æ—‹è½¬è®¾å¤‡60ç§’ï¼Œè¦†ç›–æ‰€æœ‰æ–¹å‘ï¼</p>
                    <div class="progress-bar">
                        <div id="calib-progress" class="progress-fill"></div>
                    </div>
                    <p class="progress-text">
                        <span id="calib-time">0</span>s / 60s | 
                        æ ·æœ¬æ•°: <span id="calib-samples">0</span>
                    </p>
                    <div class="mag-range">
                        <div>X: [<span id="mx-min">--</span>, <span id="mx-max">--</span>]</div>
                        <div>Y: [<span id="my-min">--</span>, <span id="my-max">--</span>]</div>
                        <div>Z: [<span id="mz-min">--</span>, <span id="mz-max">--</span>]</div>
                    </div>
                    <div class="mag-plot-wrapper">
                        <canvas id="magPlot" width="520" height="450"></canvas>
                        <div class="legend">
                            <span><span class="legend-dot" style="background:#ff6b35; color:#ff6b35"></span> åŸå§‹æ•°æ®</span>
                            <span><span class="legend-dot" style="background:#00ff88; color:#00ff88"></span> æ ¡å‡†å</span>
                        </div>
                    </div>
                </div>

                <div id="calib-step-3" class="calib-step hidden">
                    <h3>âœ… æ ¡å‡†å®Œæˆ</h3>
                    <div class="calib-result">
                        <h4>ğŸ“Š æ ¡å‡†å‚æ•°</h4>
                        <div class="param-grid">
                            <div class="param-item">
                                <label>ç¡¬é“åç½® (Offset):</label>
                                <div class="param-values">
                                    <span>X: <code id="offset-x">0</code></span>
                                    <span>Y: <code id="offset-y">0</code></span>
                                    <span>Z: <code id="offset-z">0</code></span>
                                </div>
                            </div>
                            <div class="param-item">
                                <label>è½¯é“ç¼©æ”¾ (Scale):</label>
                                <div class="param-values">
                                    <span>X: <code id="scale-x">1.000</code></span>
                                    <span>Y: <code id="scale-y">1.000</code></span>
                                    <span>Z: <code id="scale-z">1.000</code></span>
                                </div>
                            </div>
                        </div>
                        
                        <h4>ğŸ“‹ å¤åˆ¶ä»£ç åˆ°å•ç‰‡æœº</h4>
                        <pre id="calib-code" class="code-block">mag_set_calibration(
    0.0f, 0.0f, 0.0f,    // offset_x, offset_y, offset_z
    1.0f, 1.0f, 1.0f     // scale_x, scale_y, scale_z
);</pre>
                        <div class="btn-group">
                            <button class="btn btn-copy" onclick="copyCalibCode()">
                                <i data-lucide="copy"></i> å¤åˆ¶ä»£ç 
                            </button>
                            <button class="btn btn-export" onclick="exportMagData('csv')">
                                <i data-lucide="download"></i> å¯¼å‡ºCSV
                            </button>
                            <button class="btn btn-export" onclick="exportMagData('json')">
                                <i data-lucide="file-json"></i> å¯¼å‡ºJSON
                            </button>
                        </div>
                        
                        <h4>ğŸ“ˆ æ ¡å‡†è´¨é‡</h4>
                        <div id="calib-quality" class="quality-badge">--</div>
                        <p id="calib-tips" class="calib-tips"></p>
                    </div>
                    <button class="btn btn-primary" onclick="closeMagCalibModal()">å®Œæˆ</button>
                    <button class="btn btn-secondary" onclick="resetMagCalibration()">é‡æ–°æ ¡å‡†</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts / Critical modal -->
    <div class="hud-alert-container" id="hud-alert">
        <div class="hud-badge">
            <svg class="hud-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
            <span id="hud-text">System Ready</span>
        </div>
    </div>

    <div class="modal-overlay" id="critical-modal">
        <div class="error-card">
            <div class="ec-header">
                <div class="ec-icon-box">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18.42 2.11A3 3 0 0 0 16.3 1.23H7.7a3 3 0 0 0-2.12.88l-4.7 4.7a3 3 0 0 0-.88 2.12v8.6a3 3 0 0 0 .88 2.12l4.7 4.7a3 3 0 0 0 2.12.88h8.6a3 3 0 0 0 2.12-.88l4.7-4.7a3 3 0 0 0 .88-2.12V8.93a3 3 0 0 0-.88-2.12z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                </div>
                <div class="ec-title-group">
                    <div class="ec-title" id="ec-title">Critical Failure</div>
                    <div class="ec-subtitle" id="ec-subtitle">Flight Controller Halted</div>
                </div>
            </div>
            <div class="ec-body">
                <div class="ec-msg" id="ec-message">
                    The IMU sensor is not responding. The system has triggered failsafe mode to prevent unstable flight behavior.
                </div>
                <div class="error-code-box">
                    <span>ERR_CODE:</span>
                    <span id="ec-code">--</span>
                </div>
            </div>
            <div class="ec-actions">
                <button class="alert-btn alert-btn-ghost" id="ec-ignore">Ignore</button>
                <button class="alert-btn alert-btn-danger" id="ec-stop">Emergency Stop</button>
            </div>
        </div>
    </div>

    <!-- ç”µæœºå®‰å…¨ç¡®è®¤å¼¹çª— -->
    <div class="safety-modal modal-overlay hidden" id="motorSafetyModal">
        <div class="safety-card" id="motorSafetyCard">
            <button class="safety-close" id="motorSafetyClose">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            
            <!-- è¶…å¤§å›¾æ ‡åŒº -->
            <div class="icon-wrapper">
                <div class="wave"></div>
                <div class="wave"></div>
                <div class="icon-inner">
                    <svg width="42" height="42" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                </div>
            </div>

            <!-- æ–‡å­—åŒº -->
            <div class="safety-body">
                <h2>å®‰å…¨æ£€æŸ¥</h2>
                <p>
                    ç”µæœºå³å°†é«˜é€Ÿæ—‹è½¬ã€‚<br>
                    è¯·åŠ¡å¿…ç¡®è®¤ <strong>å·²æ‹†é™¤æ‰€æœ‰èºæ—‹æ¡¨</strong>ã€‚
                </p>

                <!-- å¹²å‡€çš„å¤é€‰æ¡† -->
                <label class="checkbox-row">
                    <input type="checkbox" id="motorSafetyCheck" style="display:none">
                    <div class="custom-check">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                    </div>
                    <span class="check-text">æˆ‘å·²ç¡®è®¤æ‹†é™¤èºæ—‹æ¡¨</span>
                </label>

                <!-- å°å·§åœ†æ»‘æŒ‰é’® -->
                <button class="btn-round" id="motorConfirmBtn">
                    å¼€å§‹æµ‹è¯•
                </button>
            </div>
        </div>
    </div>

    <!-- ç”µæœºæµ‹è¯•æ¨¡æ€æ¡† -->
    <div class="motor-modal modal-overlay hidden" id="motorModal">
        <div class="motor-card">
            <div class="motor-header">
                <div class="motor-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#475569" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                    ç”µæœºæµ‹è¯• <span class="motor-badge">Test Mode</span>
                </div>
                <button class="motor-close" onclick="closeMotorModal()">&times;</button>
            </div>
            <div class="motor-body">
                <div class="drone-stage">
                    <svg class="drone-svg-body" viewBox="0 0 400 400" fill="none">
                        <path d="M170 160 L60 60 L70 50 L180 150 Z" fill="#475569" stroke="#1E293B" stroke-width="2"/>
                        <path d="M230 160 L340 60 L330 50 L220 150 Z" fill="#475569" stroke="#1E293B" stroke-width="2"/>
                        <path d="M170 240 L60 340 L70 350 L180 250 Z" fill="#475569" stroke="#1E293B" stroke-width="2"/>
                        <path d="M230 240 L340 340 L330 350 L220 250 Z" fill="#475569" stroke="#1E293B" stroke-width="2"/>
                        <rect x="160" y="140" width="80" height="120" rx="20" fill="#334155" />
                        <rect x="170" y="150" width="60" height="100" rx="15" fill="#1E293B" />
                        <path d="M 185 140 L 190 125 C 190 120, 210 120, 210 125 L 215 140 Z" fill="#94A3B8" stroke="#64748B" stroke-width="1.5"/>
                        <rect x="150" y="190" width="100" height="20" rx="4" fill="#0EA5E9" fill-opacity="0.9"/>
                    </svg>

                    <div class="motor-trigger pos-fl dir-cw" onclick="toggleMotor(this)">
                        <svg class="arrow-ring-layer" viewBox="0 0 100 100">
                            <path class="ring-track" d="M 14 50 A 36 36 0 0 1 48 14.5" stroke="currentColor" fill="none" />
                            <path class="ring-arrow-head" d="M 44 6 L 60 14.5 L 44 23 Z" fill="currentColor" />
                        </svg>
                        <div class="motor-unit"><span class="motor-num">4</span><div class="motor-coil"></div></div>
                        <div class="prop-layer"><svg viewBox="0 0 100 100" width="100%" height="100%"><g transform="translate(50,50)"><path class="prop-shape" d="M-5 0 Q -10 -40 0 -45 Q 10 -40 5 0 Z" /><path class="prop-tip" d="M-2 -35 Q 0 -45 2 -35 Z" transform="translate(0, -5) scale(2)"/><path class="prop-shape" d="M-5 0 Q -10 40 0 45 Q 10 40 5 0 Z" /><path class="prop-tip" d="M-2 35 Q 0 45 2 35 Z" transform="translate(0, 5) scale(2)"/></g></svg></div>
                    </div>

                    <div class="motor-trigger pos-fr dir-ccw" onclick="toggleMotor(this)">
                        <svg class="arrow-ring-layer" viewBox="0 0 100 100">
                            <path class="ring-track" d="M 86 50 A 36 36 0 0 0 52 14.5" stroke="currentColor" fill="none" />
                            <path class="ring-arrow-head" d="M 56 6 L 40 14.5 L 56 23 Z" fill="currentColor" />
                        </svg>
                        <div class="motor-unit"><span class="motor-num">2</span><div class="motor-coil"></div></div>
                        <div class="prop-layer"><svg viewBox="0 0 100 100" width="100%" height="100%"><g transform="translate(50,50)"><path class="prop-shape" d="M-5 0 Q -10 -40 0 -45 Q 10 -40 5 0 Z" /><path class="prop-tip" d="M-2 -35 Q 0 -45 2 -35 Z" transform="translate(0, -5) scale(2)"/><path class="prop-shape" d="M-5 0 Q -10 40 0 45 Q 10 40 5 0 Z" /><path class="prop-tip" d="M-2 35 Q 0 45 2 35 Z" transform="translate(0, 5) scale(2)"/></g></svg></div>
                    </div>

                    <div class="motor-trigger pos-rl dir-ccw" onclick="toggleMotor(this)">
                        <svg class="arrow-ring-layer" viewBox="0 0 100 100">
                            <path class="ring-track" d="M 14 50 A 36 36 0 0 0 48 85.5" stroke="currentColor" fill="none" />
                            <path class="ring-arrow-head" d="M 44 77 L 60 85.5 L 44 94 Z" fill="currentColor" />
                        </svg>
                        <div class="motor-unit"><span class="motor-num">3</span><div class="motor-coil"></div></div>
                        <div class="prop-layer"><svg viewBox="0 0 100 100" width="100%" height="100%"><g transform="translate(50,50)"><path class="prop-shape" d="M-5 0 Q -10 -40 0 -45 Q 10 -40 5 0 Z" /><path class="prop-tip" d="M-2 -35 Q 0 -45 2 -35 Z" transform="translate(0, -5) scale(2)"/><path class="prop-shape" d="M-5 0 Q -10 40 0 45 Q 10 40 5 0 Z" /><path class="prop-tip" d="M-2 35 Q 0 45 2 35 Z" transform="translate(0, 5) scale(2)"/></g></svg></div>
                    </div>

                    <div class="motor-trigger pos-rr dir-cw" onclick="toggleMotor(this)">
                        <svg class="arrow-ring-layer" viewBox="0 0 100 100">
                            <path class="ring-track" d="M 86 50 A 36 36 0 0 1 52 85.5" stroke="currentColor" fill="none" />
                            <path class="ring-arrow-head" d="M 56 77 L 40 85.5 L 56 94 Z" fill="currentColor" />
                        </svg>
                        <div class="motor-unit"><span class="motor-num">1</span><div class="motor-coil"></div></div>
                        <div class="prop-layer"><svg viewBox="0 0 100 100" width="100%" height="100%"><g transform="translate(50,50)"><path class="prop-shape" d="M-5 0 Q -10 -40 0 -45 Q 10 -40 5 0 Z" /><path class="prop-tip" d="M-2 -35 Q 0 -45 2 -35 Z" transform="translate(0, -5) scale(2)"/><path class="prop-shape" d="M-5 0 Q -10 40 0 45 Q 10 40 5 0 Z" /><path class="prop-tip" d="M-2 35 Q 0 45 2 35 Z" transform="translate(0, 5) scale(2)"/></g></svg></div>
                    </div>
                </div>

                <div class="modal-footer motor-footer">
                    <button class="btn-main btn-start" id="masterBtn" onclick="toggleMaster()">å¯åŠ¨å…¨éƒ¨ç”µæœº</button>
                    <button class="btn-main btn-stop" onclick="closeMotorModal()">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript æ¨¡å— -->
    <script src="js/config.js"></script>
    <script src="js/ui-sidebar.js"></script>
    <script src="js/ui-rc-monitor.js"></script>
    <script src="js/ui-alerts.js"></script>
    <script src="js/ui-imu-card.js"></script>
    <script src="js/serial.js"></script>
    <script src="js/motor-modal.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/recording.js"></script>
    <script src="js/mag-calibration.js"></script>
    <script src="js/attitude-reset.js"></script>
    <script src="js/orientation.js"></script>
    <script src="js/scene.js"></script>
    <script src="js/drone.js"></script>
    <script src="js/app.js"></script>
    <script>
        // Console drawer toggle + resize (min/max clamp)
        document.addEventListener('DOMContentLoaded', () => {
            const drawer = document.getElementById('console-drawer');
            const header = drawer?.querySelector('.console-header');
            const minH = 120;
            const maxH = 400;
            let startY = 0;
            let startH = 0;
            let dragging = false;

            const setHeight = (h) => {
                const clamped = Math.max(minH, Math.min(maxH, h));
                drawer.style.setProperty('--console-height', `${clamped}px`);
                if (drawer.classList.contains('closed')) {
                    drawer.classList.add('closed'); // reapply transform with new height
                }
            };

            const endDrag = (toggleIfClick) => {
                if (!dragging) return;
                dragging = false;
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onUp);
                if (toggleIfClick) {
                    drawer.classList.toggle('closed');
                }
            };

            const onMove = (e) => {
                if (!dragging) return;
                const delta = startY - e.clientY;
                setHeight(startH + delta);
            };
            const onUp = (e) => {
                const delta = Math.abs(startY - e.clientY);
                endDrag(delta < 3);
            };

            if (drawer && header) {
                header.addEventListener('mousedown', (e) => {
                    if (e.target.closest('.console-ops')) return;
                    if (e.target.closest('input,button')) return;
                    startY = e.clientY;
                    startH = drawer.getBoundingClientRect().height;
                    dragging = true;
                    document.addEventListener('mousemove', onMove);
                    document.addEventListener('mouseup', onUp);
                });
            }
        });
        lucide.createIcons();
    </script>
</body>
</html>
